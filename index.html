<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>Web diff</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 20px;
    }
    .container {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
    }
    textarea {
      flex: 1;
      height: 300px;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      background: #fff;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      margin-right: 10px;
      cursor: pointer;
    }
    .diff-result {
      white-space: pre-wrap;
      font-family: monospace;
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 200px;
      counter-reset: linenumber;
    }
    .diff-result div {
      position: relative;
      display: flex;
      align-items: flex-start;
      padding: 2px 0;
      white-space: pre;
    }
    .diff-result div:before {
      counter-increment: linenumber;
      content: counter(linenumber);
      display: inline-block;
      width: 2em;
      margin-right: 8px;
      text-align: right;
      colour: #999; /* 这里是文本颜色，CSS 要用 color */
      color: #999999;
      user-select: none;
    }
    .added {
      background-color: #ccffcc;
      border: 1px solid #88cc88;
      padding: 0 2px;
      border-radius: 2px;
    }
    .deleted {
      background-color: #ffcccc;
      border: 1px solid #cc8888;
      text-decoration: line-through;
      padding: 0 2px;
      border-radius: 2px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
</head>
<body>
  <h1>Compare differences</h1>

  <div class="container">
    <textarea id="oldText" placeholder="Old text pastes here…"></textarea>
    <textarea id="newText" placeholder="New text pastes here…"></textarea>
  </div>

  <div style="margin-bottom:20px;">
    <button id="compareBtn">Compare</button>
    <button id="clearBtn">Clear</button>
  </div>

  <div id="result" class="diff-result"></div>

  <!-- 引入 jsdiff -->
  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <script>
    const oldTa      = document.getElementById('oldText');
    const newTa      = document.getElementById('newText');
    const compareBtn = document.getElementById('compareBtn');
    const clearBtn   = document.getElementById('clearBtn');
    const resultDiv  = document.getElementById('result');

    // HTML 转义
    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
    }

    // 词级别分词（包含空格、标点、换行）
    function myTokenizer(text) {
      return text.replace(/\r\n/g, '\n')
                 .replace(/\r/g, '\n')
                 .match(/\w+|[^\w\s]|\n|\s+/g) || [];
    }

    // 渲染差异并保存
    function renderDiff(oldStr, newStr) {
      const diff = Diff.diffWordsWithSpace(oldStr, newStr);

      let html = '';
      diff.forEach(part => {
        const cls = part.added   ? 'added'
                  : part.removed ? 'deleted'
                  : null;
        const text = part.value;
        if (cls) {
          // 分离前后空白，避免染色空格
          const leadMatch  = text.match(/^(\s+)/);
          const trailMatch = text.match(/(\s+)$/);
          const leading    = leadMatch  ? leadMatch[1]  : '';
          const trailing   = trailMatch ? trailMatch[1] : '';
          const core       = text.slice(leading.length, text.length - trailing.length);
          html += escapeHtml(leading)
               + `<span class="${cls}">${escapeHtml(core)}</span>`
               + escapeHtml(trailing);
        } else {
          html += escapeHtml(text);
        }
      });

      // 保留换行
      html = html.replace(/\n/g, '<br>');
      resultDiv.innerHTML = html;

      // 保存到 localStorage
      localStorage.setItem('diff_old', oldStr);
      localStorage.setItem('diff_new', newStr);
      localStorage.setItem('diff_html', html);
    }

    // 初始化时恢复
    window.addEventListener('DOMContentLoaded', () => {
      const o = localStorage.getItem('diff_old')  || '';
      const n = localStorage.getItem('diff_new')  || '';
      const h = localStorage.getItem('diff_html') || '';
      oldTa.value     = o;
      newTa.value     = n;
      resultDiv.innerHTML = h;
    });

    compareBtn.addEventListener('click', () => {
      renderDiff(oldTa.value, newTa.value);
    });

    clearBtn.addEventListener('click', () => {
      oldTa.value = '';
      newTa.value = '';
      resultDiv.innerHTML = '';
      localStorage.removeItem('diff_old');
      localStorage.removeItem('diff_new');
      localStorage.removeItem('diff_html');
    });
  </script>
</body>
</html>
